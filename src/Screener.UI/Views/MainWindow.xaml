<Window x:Class="Screener.UI.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:Screener.UI.ViewModels"
        xmlns:controls="clr-namespace:Screener.UI.Views.Controls"
        mc:Ignorable="d"
        Title="Screener - Video Capture"
        Icon="/screener.ico"
        Height="800" Width="1400"
        MinHeight="720" MinWidth="1280"
        Background="{DynamicResource BackgroundLevel0Brush}"
        WindowStartupLocation="CenterScreen">

    <Window.InputBindings>
        <KeyBinding Key="F9" Command="{Binding ToggleRecordingCommand}"/>
        <KeyBinding Key="F9" Modifiers="Shift" Command="{Binding TogglePauseCommand}"/>
        <KeyBinding Key="M" Command="{Binding AddMarkerCommand}"/>
        <KeyBinding Key="I" Command="{Binding SetInPointCommand}"/>
        <KeyBinding Key="O" Command="{Binding SetOutPointCommand}"/>
        <KeyBinding Key="F11" Command="{Binding ToggleFullscreenCommand}"/>
        <KeyBinding Key="Esc" Command="{Binding ExitFullscreenCommand}"/>
        <KeyBinding Key="OemComma" Modifiers="Ctrl" Command="{Binding OpenSettingsCommand}"/>
    </Window.InputBindings>

    <Grid>
        <Grid.RowDefinitions>
            <!-- Menu Bar -->
            <RowDefinition Height="Auto"/>
            <!-- Toolbar -->
            <RowDefinition Height="Auto"/>
            <!-- Main Content -->
            <RowDefinition Height="*"/>
            <!-- Status Bar -->
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Menu Bar -->
        <Menu Grid.Row="0" Background="{DynamicResource BackgroundLevel1Brush}">
            <MenuItem Header="_File">
                <MenuItem Header="_New Project" InputGestureText="Ctrl+N"/>
                <MenuItem Header="_Open Project" InputGestureText="Ctrl+O"/>
                <Separator/>
                <MenuItem Header="E_xit" Command="{Binding ExitCommand}" InputGestureText="Alt+F4"/>
            </MenuItem>
            <MenuItem Header="_Recording">
                <MenuItem Header="_Start Recording" Command="{Binding ToggleRecordingCommand}" InputGestureText="F9"/>
                <MenuItem Header="_Pause Recording" Command="{Binding TogglePauseCommand}" InputGestureText="Shift+F9"/>
                <Separator/>
                <MenuItem Header="Add _Marker" Command="{Binding AddMarkerCommand}" InputGestureText="M"/>
                <MenuItem Header="Set _In Point" Command="{Binding SetInPointCommand}" InputGestureText="I"/>
                <MenuItem Header="Set _Out Point" Command="{Binding SetOutPointCommand}" InputGestureText="O"/>
            </MenuItem>
            <MenuItem Header="_View">
                <MenuItem Header="_Fullscreen Preview" Command="{Binding ToggleFullscreenCommand}" InputGestureText="F11"/>
                <Separator/>
                <MenuItem Header="Show _Left Panel" IsCheckable="True" IsChecked="{Binding IsLeftPanelVisible}"/>
                <MenuItem Header="Show _Right Panel" IsCheckable="True" IsChecked="{Binding IsRightPanelVisible}"/>
            </MenuItem>
            <MenuItem Header="_Stream">
                <MenuItem Command="{Binding ToggleStreamCommand}">
                    <MenuItem.Style>
                        <Style TargetType="MenuItem">
                            <Setter Property="Header" Value="_Start Stream"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsStreaming}" Value="True">
                                    <Setter Property="Header" Value="_Stop Stream"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </MenuItem.Style>
                </MenuItem>
                <MenuItem Header="_Copy Stream URL" Command="{Binding CopyStreamUrlCommand}"/>
                <Separator/>
                <MenuItem Header="_NDI Output" IsCheckable="True" IsChecked="{Binding IsNdiOutputActive}"
                          Visibility="{Binding IsNdiAvailable, Converter={StaticResource BoolToVisibilityConverter}}"/>
                <MenuItem Header="S_RT Output" IsCheckable="True" IsChecked="{Binding IsSrtOutputActive}"/>
                <Separator/>
                <MenuItem Header="Stream _Settings..." Command="{Binding OpenStreamSettingsCommand}"/>
            </MenuItem>
            <MenuItem Header="_Tools">
                <MenuItem Header="_Settings..." Command="{Binding OpenSettingsCommand}" InputGestureText="Ctrl+,"/>
                <MenuItem Header="_Scheduler..." Command="{Binding OpenSchedulerCommand}"/>
            </MenuItem>
            <MenuItem Header="_Help">
                <MenuItem Header="_About Screener"/>
            </MenuItem>
        </Menu>

        <!-- Toolbar -->
        <Border Grid.Row="1" Background="{DynamicResource ToolbarGradient}"
                BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="0,0,0,1"
                Padding="8,6">
            <StackPanel Orientation="Horizontal">
                <!-- Quality Preset -->
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="8,0">
                    <TextBlock Text="Preset:" Foreground="{DynamicResource TextSecondaryBrush}"
                               VerticalAlignment="Center" Margin="0,0,8,0"/>
                    <ComboBox Width="120"
                              ItemsSource="{Binding AvailablePresets}"
                              SelectedItem="{Binding SelectedPreset}"
                              DisplayMemberPath="Name"/>
                </StackPanel>

                <!-- Separator -->
                <Border Width="1" Height="32" Margin="8,0" Opacity="0.4">
                    <Border.Background>
                        <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                            <GradientStop Color="Transparent" Offset="0"/>
                            <GradientStop Color="{StaticResource BorderMedium}" Offset="0.5"/>
                            <GradientStop Color="Transparent" Offset="1"/>
                        </LinearGradientBrush>
                    </Border.Background>
                </Border>

                <!-- Drive Selector -->
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="8,0">
                    <TextBlock Text="Drive:" Foreground="{DynamicResource TextSecondaryBrush}"
                               VerticalAlignment="Center" Margin="0,0,8,0"/>
                    <ComboBox Width="200"
                              ItemsSource="{Binding AvailableDrives}"
                              SelectedItem="{Binding SelectedDrive}">
                        <ComboBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="{Binding Name}" Margin="0,0,8,0"/>
                                    <TextBlock Text="{Binding FreeSpaceDisplay}"
                                               Foreground="{DynamicResource TextSecondaryBrush}"/>
                                </StackPanel>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>
                </StackPanel>

                <!-- Separator -->
                <Border Width="1" Height="32" Margin="8,0" Opacity="0.4">
                    <Border.Background>
                        <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                            <GradientStop Color="Transparent" Offset="0"/>
                            <GradientStop Color="{StaticResource BorderMedium}" Offset="0.5"/>
                            <GradientStop Color="Transparent" Offset="1"/>
                        </LinearGradientBrush>
                    </Border.Background>
                </Border>

                <!-- Stream Toggle -->
                <ToggleButton Style="{DynamicResource StreamToggleButtonStyle}"
                              IsChecked="{Binding IsStreaming}"
                              ToolTip="Toggle Stream"
                              Height="32" Margin="8,0"/>

                <!-- NDI Output Toggle (visible only when NDI runtime installed) -->
                <ToggleButton IsChecked="{Binding IsNdiOutputActive}"
                              ToolTip="Toggle NDI Output"
                              Height="32" Margin="4,0"
                              Padding="8,4"
                              Visibility="{Binding IsNdiAvailable, Converter={StaticResource BoolToVisibilityConverter}}">
                    <TextBlock Text="NDI" FontSize="11" FontWeight="SemiBold"/>
                </ToggleButton>

                <!-- SRT Output Toggle -->
                <ToggleButton IsChecked="{Binding IsSrtOutputActive}"
                              ToolTip="Toggle SRT Output"
                              Height="32" Margin="4,0"
                              Padding="8,4">
                    <TextBlock Text="SRT" FontSize="11" FontWeight="SemiBold"/>
                </ToggleButton>

                <!-- SRT Output Status -->
                <TextBlock Text="{Binding SrtOutputStatus}"
                           Foreground="{DynamicResource AccentBlueBrush}"
                           VerticalAlignment="Center" Margin="4,0,0,0"
                           FontSize="11"
                           Visibility="{Binding IsSrtOutputActive, Converter={StaticResource BoolToVisibilityConverter}}"/>

                <!-- Stream URL with fade-in (visible when streaming) -->
                <StackPanel x:Name="StreamUrlPanel" Orientation="Horizontal" VerticalAlignment="Center"
                            Visibility="{Binding IsStreaming, Converter={StaticResource BoolToVisibilityConverter}}">
                    <StackPanel.Style>
                        <Style TargetType="StackPanel">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsStreaming}" Value="True">
                                    <DataTrigger.EnterActions>
                                        <BeginStoryboard>
                                            <Storyboard>
                                                <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                 From="0" To="1" Duration="0:0:0.3"/>
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </DataTrigger.EnterActions>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </StackPanel.Style>
                    <TextBlock Text="{Binding StreamUrl, TargetNullValue='Starting...'}"
                               Foreground="{DynamicResource AccentBlueBrush}"
                               VerticalAlignment="Center" Margin="8,0,0,0"
                               FontSize="11"/>
                    <Button Content="Copy" Command="{Binding CopyStreamUrlCommand}"
                            Margin="4,0,0,0" Padding="8,2"
                            FontSize="11" VerticalAlignment="Center"
                            Style="{DynamicResource SecondaryButtonStyle}"/>
                    <Button x:Name="QrButton" Content="QR" Command="{Binding ShowQrCodeCommand}"
                            Margin="4,0,0,0" Padding="8,2"
                            FontSize="11" VerticalAlignment="Center"
                            Style="{DynamicResource SecondaryButtonStyle}"/>
                </StackPanel>
            </StackPanel>
        </Border>

        <!-- QR Code Popup -->
        <Popup IsOpen="{Binding IsQrCodeVisible}" StaysOpen="False"
               PlacementTarget="{Binding ElementName=QrButton}" Placement="Bottom"
               PopupAnimation="Fade" AllowsTransparency="True">
            <Border Background="{DynamicResource BackgroundLevel2Brush}"
                    BorderBrush="{DynamicResource BorderMediumBrush}"
                    BorderThickness="1" CornerRadius="8" Padding="16"
                    Effect="{DynamicResource FloatingShadow}">
                <StackPanel>
                    <TextBlock Text="Scan to connect" Foreground="{DynamicResource TextSecondaryBrush}"
                               FontSize="12" HorizontalAlignment="Center" Margin="0,0,0,8"/>
                    <Image Source="{Binding QrCodeImage, Converter={StaticResource ByteArrayToImageConverter}}"
                           Width="200" Height="200"
                           RenderOptions.BitmapScalingMode="NearestNeighbor"/>
                    <TextBlock Text="{Binding StreamUrl}" Foreground="{DynamicResource AccentBlueBrush}"
                               FontSize="11" HorizontalAlignment="Center" Margin="0,8,0,0"
                               TextWrapping="Wrap" MaxWidth="200"/>
                </StackPanel>
            </Border>
        </Popup>

        <!-- Viewers Popup -->
        <Popup IsOpen="{Binding IsViewersPopupVisible}" StaysOpen="False"
               PlacementTarget="{Binding ElementName=ViewersButton}" Placement="Top"
               PopupAnimation="Fade" AllowsTransparency="True">
            <Border Background="{DynamicResource BackgroundLevel2Brush}"
                    BorderBrush="{DynamicResource BorderMediumBrush}"
                    BorderThickness="1" CornerRadius="8" Padding="12"
                    Effect="{DynamicResource FloatingShadow}"
                    MinWidth="280">
                <StackPanel>
                    <TextBlock Text="Connected Viewers" Foreground="{DynamicResource TextPrimaryBrush}"
                               FontSize="13" FontWeight="SemiBold" Margin="0,0,0,8"/>

                    <!-- Viewer list -->
                    <ItemsControl ItemsSource="{Binding ConnectedViewersList}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="{DynamicResource BackgroundLevel1Brush}"
                                        CornerRadius="4" Padding="8,6" Margin="0,0,0,4">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <StackPanel Grid.Column="0">
                                            <TextBlock Foreground="{DynamicResource TextPrimaryBrush}" FontSize="12">
                                                <Run Text="{Binding RemoteAddress, Mode=OneWay}"/>
                                            </TextBlock>
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="{Binding Id, StringFormat='ID: {0}'}"
                                                           Foreground="{DynamicResource TextSecondaryBrush}" FontSize="10"/>
                                                <TextBlock Text=" | " Foreground="{DynamicResource TextSecondaryBrush}" FontSize="10"/>
                                                <TextBlock Text="{Binding ConnectionDuration}"
                                                           Foreground="{DynamicResource TextSecondaryBrush}" FontSize="10"/>
                                            </StackPanel>
                                        </StackPanel>
                                        <Button Grid.Column="1" Content="&#xE711;" FontFamily="Segoe MDL2 Assets"
                                                FontSize="12" Foreground="{DynamicResource AccentRedBrush}"
                                                Background="Transparent" BorderThickness="0" Cursor="Hand"
                                                Padding="4,2" VerticalAlignment="Center"
                                                Command="{Binding DataContext.DisconnectViewerCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                CommandParameter="{Binding Id}"
                                                ToolTip="Disconnect viewer"/>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- No viewers fallback -->
                    <TextBlock Text="No viewers connected" FontSize="12"
                               Foreground="{DynamicResource TextSecondaryBrush}"
                               HorizontalAlignment="Center" Margin="0,4,0,4">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ConnectedViewersList.Count}" Value="0">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>
                </StackPanel>
            </Border>
        </Popup>

        <!-- Main Content Area -->
        <Grid Grid.Row="2">
            <Grid.ColumnDefinitions>
                <!-- Left Panel -->
                <ColumnDefinition Width="280" MinWidth="200" MaxWidth="450"/>
                <ColumnDefinition Width="Auto"/>
                <!-- Center (Preview) -->
                <ColumnDefinition Width="*" MinWidth="640"/>
                <ColumnDefinition Width="Auto"/>
                <!-- Right Panel -->
                <ColumnDefinition Width="300" MinWidth="240" MaxWidth="400"/>
            </Grid.ColumnDefinitions>

            <!-- Left Panel: Clip Bin & Upload Queue -->
            <Grid Grid.Column="0" Background="{DynamicResource BackgroundLevel1Brush}"
                  Visibility="{Binding IsLeftPanelVisible, Converter={StaticResource BoolToVisibilityConverter}}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="200"/>
                </Grid.RowDefinitions>

                <!-- Clip Bin -->
                <Border Grid.Row="0" Margin="4">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <TextBlock Text="CLIP BIN" Style="{DynamicResource PanelHeaderStyle}" Grid.Row="0"/>
                        <ListBox Grid.Row="1"
                                 ItemsSource="{Binding ClipBin.Clips}"
                                 SelectedItem="{Binding ClipBin.SelectedClip}"
                                 Background="Transparent"
                                 BorderThickness="0"
                                 HorizontalContentAlignment="Stretch"
                                 ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                            <ListBox.ItemContainerStyle>
                                <Style TargetType="ListBoxItem">
                                    <Setter Property="Padding" Value="6"/>
                                    <Setter Property="Margin" Value="0,2"/>
                                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="ListBoxItem">
                                                <Border x:Name="Border"
                                                        Background="{DynamicResource BackgroundLevel2Brush}"
                                                        BorderBrush="{DynamicResource BorderSubtleBrush}"
                                                        BorderThickness="1"
                                                        CornerRadius="4"
                                                        Padding="{TemplateBinding Padding}">
                                                    <ContentPresenter/>
                                                </Border>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsSelected" Value="True">
                                                        <Setter TargetName="Border" Property="BorderBrush" Value="{DynamicResource AccentBlueBrush}"/>
                                                    </Trigger>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter TargetName="Border" Property="Background" Value="{DynamicResource BackgroundLevel3Brush}"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </ListBox.ItemContainerStyle>
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <!-- Clip name and info -->
                                        <TextBlock Grid.Row="0" Grid.Column="0"
                                                   Text="{Binding FileName}"
                                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                                   FontSize="12" TextTrimming="CharacterEllipsis"
                                                   ToolTip="{Binding FilePath}"/>

                                        <!-- Action buttons -->
                                        <StackPanel Grid.Row="0" Grid.Column="1" Orientation="Horizontal">
                                            <Button Content="&#xE8A7;" FontFamily="Segoe MDL2 Assets" FontSize="12"
                                                    Command="{Binding PlayFileCommand}"
                                                    ToolTip="Play"
                                                    Background="Transparent" BorderThickness="0"
                                                    Foreground="{DynamicResource TextSecondaryBrush}"
                                                    Cursor="Hand" Padding="4,2" Margin="2,0"/>
                                            <Button Content="&#xED25;" FontFamily="Segoe MDL2 Assets" FontSize="12"
                                                    Command="{Binding RevealInExplorerCommand}"
                                                    ToolTip="Show in Explorer"
                                                    Background="Transparent" BorderThickness="0"
                                                    Foreground="{DynamicResource TextSecondaryBrush}"
                                                    Cursor="Hand" Padding="4,2" Margin="2,0"/>
                                        </StackPanel>

                                        <!-- Duration and file size -->
                                        <StackPanel Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                                                    Orientation="Horizontal" Margin="0,2,0,0">
                                            <TextBlock Text="{Binding Duration, StringFormat='{}{0:hh\\:mm\\:ss}'}"
                                                       Foreground="{DynamicResource TextSecondaryBrush}" FontSize="11"/>
                                            <TextBlock Text=" - " Foreground="{DynamicResource TextSecondaryBrush}" FontSize="11"/>
                                            <TextBlock Text="{Binding FileSizeDisplay}"
                                                       Foreground="{DynamicResource TextSecondaryBrush}" FontSize="11"/>
                                        </StackPanel>
                                    </Grid>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </Grid>
                </Border>

                <GridSplitter Grid.Row="1" Height="5" HorizontalAlignment="Stretch"
                              Background="{DynamicResource BorderSubtleBrush}"/>

                <!-- Upload Queue -->
                <Border Grid.Row="2" Margin="4">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <TextBlock Text="UPLOAD QUEUE" Style="{DynamicResource PanelHeaderStyle}" Grid.Row="0"/>
                        <ListBox Grid.Row="1"
                                 ItemsSource="{Binding UploadQueue.Jobs}"
                                 Background="Transparent"
                                 BorderThickness="0">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <Grid Margin="4">
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>
                                        <TextBlock Text="{Binding FileName}" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                        <ProgressBar Grid.Row="1" Height="4" Margin="0,4,0,0"
                                                     Value="{Binding ProgressPercent}"
                                                     Background="{DynamicResource BackgroundLevel2Brush}"
                                                     Foreground="{DynamicResource AccentBlueBrush}"/>
                                    </Grid>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </Grid>
                </Border>
            </Grid>

            <GridSplitter Grid.Column="1" Width="5" HorizontalAlignment="Center"
                          Background="{DynamicResource BorderSubtleBrush}"
                          Visibility="{Binding IsLeftPanelVisible, Converter={StaticResource BoolToVisibilityConverter}}"/>

            <!-- Center: Multi-View Preview -->
            <Grid Grid.Column="2" Background="{DynamicResource BackgroundLevel0Brush}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Video Preview Area -->
                <Border Grid.Row="0" Margin="8"
                        BorderBrush="{Binding RecordingBorderBrush}"
                        BorderThickness="{Binding RecordingBorderThickness}">
                    <Grid>
                        <!-- Multi-View Grid -->
                        <ItemsControl ItemsSource="{Binding EnabledInputs}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <UniformGrid Columns="{Binding DataContext.PreviewColumns, RelativeSource={RelativeSource AncestorType=ItemsControl}}"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate DataType="{x:Type vm:InputViewModel}">
                                    <Button Command="{Binding DataContext.SelectInputCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                            CommandParameter="{Binding}">
                                        <Button.Template>
                                            <ControlTemplate TargetType="Button">
                                                <Border x:Name="CellBorder" Margin="2" Background="#111"
                                                        BorderThickness="2" BorderBrush="Transparent"
                                                        Cursor="Hand">
                                                    <Grid>
                                                        <Viewbox Stretch="Uniform">
                                                            <Border Width="1920" Height="1080" Background="#1A1A1A">
                                                                <Image Source="{Binding PreviewImage}" Stretch="Fill"
                                                                       RenderOptions.BitmapScalingMode="LowQuality"/>
                                                            </Border>
                                                        </Viewbox>
                                                        <!-- Input label overlay -->
                                                        <Border HorizontalAlignment="Left" VerticalAlignment="Top"
                                                                Background="#80000000" Padding="6,2" Margin="8,4">
                                                            <TextBlock Text="{Binding ShortName}"
                                                                       Foreground="White" FontSize="12" FontWeight="SemiBold"/>
                                                        </Border>
                                                        <!-- No signal overlay -->
                                                        <TextBlock Text="NO SIGNAL"
                                                                   HorizontalAlignment="Center" VerticalAlignment="Center"
                                                                   FontSize="32" Foreground="#666"
                                                                   Visibility="{Binding HasSignal, Converter={StaticResource InverseBoolToVisibilityConverter}}"/>
                                                        <!-- Format description overlay -->
                                                        <TextBlock Text="{Binding FormatDescription}"
                                                                   HorizontalAlignment="Right" VerticalAlignment="Bottom"
                                                                   Margin="0,0,8,4" Padding="4,2"
                                                                   Background="#80000000" Foreground="#999"
                                                                   FontSize="10"/>
                                                    </Grid>
                                                </Border>
                                                <ControlTemplate.Triggers>
                                                    <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                                        <Setter TargetName="CellBorder" Property="BorderBrush" Value="#2196F3"/>
                                                    </DataTrigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Button.Template>
                                    </Button>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <!-- No inputs enabled overlay -->
                        <TextBlock Text="NO SIGNAL"
                                   HorizontalAlignment="Center" VerticalAlignment="Center"
                                   FontSize="48" Foreground="{DynamicResource TextSecondaryBrush}"
                                   Visibility="{Binding HasNoSignal, Converter={StaticResource BoolToVisibilityConverter}}"/>

                        <!-- Timecode Overlay -->
                        <Border HorizontalAlignment="Left" VerticalAlignment="Bottom"
                                Background="#80000000" Padding="12,6" Margin="20"
                                IsHitTestVisible="False">
                            <controls:TimecodeDisplay Timecode="{Binding Timecode.CurrentTimecode}"/>
                        </Border>

                        <!-- Recording Indicator -->
                        <Border x:Name="RecIndicator" HorizontalAlignment="Right" VerticalAlignment="Top"
                                Padding="12,6" Margin="20"
                                IsHitTestVisible="False"
                                Visibility="{Binding IsRecording, Converter={StaticResource BoolToVisibilityConverter}}">
                            <Border.Style>
                                <Style TargetType="Border">
                                    <Setter Property="Background" Value="#E0FF0000"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsPaused}" Value="True">
                                            <Setter Property="Background" Value="#E0CCAA00"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>
                            <StackPanel Orientation="Horizontal">
                                <Ellipse Width="12" Height="12" Fill="White" Margin="0,0,8,0">
                                    <Ellipse.Style>
                                        <Style TargetType="Ellipse">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsPaused}" Value="True">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Ellipse.Style>
                                </Ellipse>
                                <TextBlock Foreground="White" FontWeight="Bold">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Text" Value="REC"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsPaused}" Value="True">
                                                    <Setter Property="Text" Value="PAUSED"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                                <TextBlock Text="{Binding RecordingDuration, StringFormat=' {0:hh\\:mm\\:ss}'}"
                                           Foreground="White" FontWeight="Bold"/>
                            </StackPanel>
                        </Border>
                    </Grid>
                </Border>

                <!-- Preview Toolbar -->
                <Border Grid.Row="1" Background="{DynamicResource BackgroundLevel1Brush}" Padding="8">
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                        <TextBlock Text="{Binding InputStatus}"
                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                   VerticalAlignment="Center"/>
                    </StackPanel>
                </Border>
            </Grid>

            <GridSplitter Grid.Column="3" Width="5" HorizontalAlignment="Center"
                          Background="{DynamicResource BorderSubtleBrush}"
                          Visibility="{Binding IsRightPanelVisible, Converter={StaticResource BoolToVisibilityConverter}}"/>

            <!-- Right Panel: Recording Controls & Meters -->
            <ScrollViewer Grid.Column="4" VerticalScrollBarVisibility="Auto"
                          HorizontalScrollBarVisibility="Disabled"
                          Background="{DynamicResource BackgroundLevel0Brush}"
                          Visibility="{Binding IsRightPanelVisible, Converter={StaticResource BoolToVisibilityConverter}}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Recording Controls -->
                <Border Grid.Row="0" Margin="4,4,4,2" Padding="0"
                        Background="{DynamicResource BackgroundLevel2Brush}"
                        BorderBrush="{DynamicResource BorderSubtleBrush}"
                        BorderThickness="1" CornerRadius="6">
                    <StackPanel>
                        <Border Background="{DynamicResource PanelHeaderGradient}" CornerRadius="6,6,0,0" Padding="0">
                            <Border BorderBrush="{DynamicResource AccentBlueBrush}" BorderThickness="3,0,0,0"
                                    CornerRadius="6,0,0,0" Padding="10,8,10,8">
                                <TextBlock Text="RECORDING" Style="{DynamicResource PanelHeaderStyle}" Margin="0"/>
                            </Border>
                        </Border>

                        <!-- Recording Name Input -->
                        <StackPanel Margin="10,8,10,10">
                            <TextBlock Text="Recording Name" Foreground="{DynamicResource TextSecondaryBrush}"
                                       FontSize="11" Margin="0,0,0,4"/>
                            <TextBox Text="{Binding RecordingName, UpdateSourceTrigger=PropertyChanged}"
                                     Background="{DynamicResource BackgroundLevel0Brush}"
                                     Foreground="{DynamicResource TextPrimaryBrush}"
                                     BorderBrush="{DynamicResource BorderSubtleBrush}"
                                     Padding="8,6"/>

                            <Grid Margin="0,12,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <Button Grid.Column="0" Style="{DynamicResource RecordButtonStyle}"
                                        Command="{Binding ToggleRecordingCommand}"
                                        HorizontalAlignment="Center" Width="64" Height="64"/>

                                <Button Grid.Column="1" Style="{DynamicResource ToolbarButtonStyle}"
                                        Command="{Binding StopRecordingCommand}"
                                        HorizontalAlignment="Center" Width="48" Height="48"
                                        IsEnabled="{Binding IsRecording}">
                                    <Rectangle Width="20" Height="20" Fill="White"/>
                                </Button>

                                <Button Grid.Column="2" Style="{DynamicResource ToolbarButtonStyle}"
                                        Command="{Binding TogglePauseCommand}"
                                        HorizontalAlignment="Center" Width="48" Height="48"
                                        IsEnabled="{Binding IsRecording}">
                                    <TextBlock Text="â¸" FontSize="20" Foreground="White"/>
                                </Button>
                            </Grid>

                            <TextBlock Text="{Binding RecordingStatusText}"
                                       HorizontalAlignment="Center" Margin="0,12,0,0"
                                       Foreground="{DynamicResource TextPrimaryBrush}"
                                       FontSize="14"/>
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- Quick Schedule -->
                <Border Grid.Row="1" Margin="4,2,4,2" Padding="0"
                        Background="{DynamicResource BackgroundLevel2Brush}"
                        BorderBrush="{DynamicResource BorderSubtleBrush}"
                        BorderThickness="1" CornerRadius="6">
                    <StackPanel>
                        <Border Background="{DynamicResource PanelHeaderGradient}" CornerRadius="6,6,0,0" Padding="0">
                            <Border BorderBrush="{DynamicResource AccentYellowBrush}" BorderThickness="3,0,0,0"
                                    CornerRadius="6,0,0,0" Padding="10,8,10,8">
                                <TextBlock Style="{DynamicResource PanelHeaderStyle}" Margin="0">
                                    <Run Text="SCHEDULE"/>
                                    <Run Text=" &#x2014; " Foreground="{DynamicResource TextSecondaryBrush}"/>
                                    <Run Text="{Binding InputConfiguration.SelectedInput.ShortName, Mode=OneWay}"
                                         Foreground="{DynamicResource TextSecondaryBrush}"/>
                                </TextBlock>
                            </Border>
                        </Border>

                        <StackPanel Margin="10,8,10,10">
                            <!-- Start Time -->
                            <TextBlock Text="Start Time" Foreground="{DynamicResource TextSecondaryBrush}"
                                       FontSize="11" Margin="0,0,0,4"/>
                            <TextBox Text="{Binding ScheduledStartTime, StringFormat='{}{0:HH:mm}', UpdateSourceTrigger=PropertyChanged}"
                                     Background="{DynamicResource BackgroundLevel0Brush}"
                                     Foreground="{DynamicResource TextPrimaryBrush}"
                                     BorderBrush="{DynamicResource BorderSubtleBrush}"
                                     Padding="8,6" ToolTip="Enter time as HH:mm (24-hour format)"/>

                            <!-- Duration -->
                            <TextBlock Text="Duration" Foreground="{DynamicResource TextSecondaryBrush}"
                                       FontSize="11" Margin="0,8,0,4"/>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBox Grid.Column="0"
                                         Text="{Binding ScheduledDurationHours, UpdateSourceTrigger=PropertyChanged}"
                                         Background="{DynamicResource BackgroundLevel0Brush}"
                                         Foreground="{DynamicResource TextPrimaryBrush}"
                                         BorderBrush="{DynamicResource BorderSubtleBrush}"
                                         Padding="8,6" TextAlignment="Center"/>
                                <TextBlock Grid.Column="1" Text="h" Foreground="{DynamicResource TextSecondaryBrush}"
                                           VerticalAlignment="Center" Margin="4,0,8,0"/>
                                <TextBox Grid.Column="2"
                                         Text="{Binding ScheduledDurationMinutes, UpdateSourceTrigger=PropertyChanged}"
                                         Background="{DynamicResource BackgroundLevel0Brush}"
                                         Foreground="{DynamicResource TextPrimaryBrush}"
                                         BorderBrush="{DynamicResource BorderSubtleBrush}"
                                         Padding="8,6" TextAlignment="Center"/>
                                <TextBlock Grid.Column="3" Text="m" Foreground="{DynamicResource TextSecondaryBrush}"
                                           VerticalAlignment="Center" Margin="4,0,0,0"/>
                            </Grid>

                            <!-- Schedule Buttons -->
                            <Grid Margin="0,12,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Button Grid.Column="0" Content="Schedule"
                                        Command="{Binding CreateQuickScheduleCommand}"
                                        Margin="0,0,4,0" Padding="8,6"
                                        Background="{DynamicResource AccentBlueBrush}"
                                        Foreground="White"/>
                                <Button Grid.Column="1" Content="Manage..."
                                        Command="{Binding OpenSchedulerCommand}"
                                        Margin="4,0,0,0" Padding="8,6"
                                        Background="{DynamicResource BackgroundLevel3Brush}"
                                        Foreground="{DynamicResource TextPrimaryBrush}"/>
                            </Grid>

                            <!-- Schedule Status -->
                            <TextBlock Text="{Binding ScheduleStatusText}"
                                       Foreground="{DynamicResource AccentBlueBrush}"
                                       FontSize="11" Margin="0,8,0,0"
                                       TextWrapping="Wrap"
                                       Visibility="{Binding ScheduleStatusText, Converter={StaticResource NullToVisibilityConverter}}"/>
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- Inputs Selection -->
                <Border Grid.Row="2" Margin="4,2,4,2" Padding="0"
                        Background="{DynamicResource BackgroundLevel2Brush}"
                        BorderBrush="{DynamicResource BorderSubtleBrush}"
                        BorderThickness="1" CornerRadius="6">
                    <StackPanel>
                        <Border Background="{DynamicResource PanelHeaderGradient}" CornerRadius="6,6,0,0" Padding="0">
                            <Border BorderBrush="{DynamicResource AccentGreenBrush}" BorderThickness="3,0,0,0"
                                    CornerRadius="6,0,0,0" Padding="10,8,10,8">
                                <TextBlock Text="INPUTS" Style="{DynamicResource PanelHeaderStyle}" Margin="0"/>
                            </Border>
                        </Border>
                        <StackPanel Margin="10,4,10,10">
                        <TextBlock Text="Click to preview, check to record"
                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                   FontSize="10" Margin="0,4,0,0"/>
                        <ListBox ItemsSource="{Binding InputConfiguration.Inputs}"
                                 SelectedItem="{Binding InputConfiguration.SelectedInput}"
                                 Margin="0,8,0,0"
                                 Background="Transparent"
                                 BorderThickness="0">
                            <ListBox.ItemContainerStyle>
                                <Style TargetType="ListBoxItem">
                                    <Setter Property="Padding" Value="4"/>
                                    <Setter Property="Margin" Value="0,1"/>
                                    <Setter Property="Background" Value="Transparent"/>
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="ListBoxItem">
                                                <Border x:Name="Border"
                                                        Background="{TemplateBinding Background}"
                                                        BorderBrush="{DynamicResource BorderSubtleBrush}"
                                                        BorderThickness="1"
                                                        CornerRadius="4"
                                                        Padding="{TemplateBinding Padding}">
                                                    <ContentPresenter/>
                                                </Border>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsSelected" Value="True">
                                                        <Setter TargetName="Border" Property="Background" Value="{DynamicResource AccentBlueBrush}"/>
                                                        <Setter TargetName="Border" Property="BorderBrush" Value="{DynamicResource AccentBlueBrush}"/>
                                                    </Trigger>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter TargetName="Border" Property="Background" Value="{DynamicResource BackgroundLevel2Brush}"/>
                                                    </Trigger>
                                                    <MultiTrigger>
                                                        <MultiTrigger.Conditions>
                                                            <Condition Property="IsSelected" Value="True"/>
                                                            <Condition Property="IsMouseOver" Value="True"/>
                                                        </MultiTrigger.Conditions>
                                                        <Setter TargetName="Border" Property="Background" Value="{DynamicResource AccentBlueBrush}"/>
                                                    </MultiTrigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </ListBox.ItemContainerStyle>
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <CheckBox Grid.Column="0" IsChecked="{Binding IsEnabled}"
                                                  VerticalAlignment="Center" Margin="0,0,8,0"
                                                  ToolTip="Enable for recording"/>
                                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="{Binding ShortName}"
                                                           Foreground="{DynamicResource TextPrimaryBrush}"
                                                           FontWeight="SemiBold" FontSize="12"/>
                                                <!-- NDI type badge -->
                                                <Border Margin="6,0,0,0" Padding="4,1" CornerRadius="2"
                                                        Background="{DynamicResource AccentBlueBrush}" VerticalAlignment="Center">
                                                    <Border.Style>
                                                        <Style TargetType="Border">
                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding Connector}" Value="NDI">
                                                                    <Setter Property="Visibility" Value="Visible"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Border.Style>
                                                    <TextBlock Text="NDI" Foreground="White" FontSize="9" FontWeight="Bold"/>
                                                </Border>
                                                <!-- SRT type badge -->
                                                <Border Margin="6,0,0,0" Padding="4,1" CornerRadius="2"
                                                        Background="{DynamicResource AccentOrangeBrush}" VerticalAlignment="Center">
                                                    <Border.Style>
                                                        <Style TargetType="Border">
                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding Connector}" Value="SRT">
                                                                    <Setter Property="Visibility" Value="Visible"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Border.Style>
                                                    <TextBlock Text="SRT" Foreground="White" FontSize="9" FontWeight="Bold"/>
                                                </Border>
                                            </StackPanel>
                                            <TextBlock Text="{Binding DisplayName}"
                                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                                       FontSize="10"/>
                                        </StackPanel>
                                        <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                                            <!-- Schedule clock icon -->
                                            <TextBlock Text="&#xE823;" FontFamily="Segoe MDL2 Assets"
                                                       FontSize="12" Foreground="{DynamicResource AccentYellowBrush}"
                                                       VerticalAlignment="Center" Margin="4,0,0,0"
                                                       ToolTip="Scheduled"
                                                       Visibility="{Binding HasSchedule, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                            <!-- Signal dot -->
                                            <Ellipse Width="8" Height="8"
                                                     VerticalAlignment="Center" Margin="4,0,0,0"
                                                     ToolTip="{Binding StatusText}">
                                                <Ellipse.Style>
                                                    <Style TargetType="Ellipse">
                                                        <Setter Property="Fill" Value="#666666"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding HasSignal}" Value="True">
                                                                <Setter Property="Fill" Value="#44FF44"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Ellipse.Style>
                                            </Ellipse>
                                        </StackPanel>
                                    </Grid>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- Timecode Display -->
                <Border Grid.Row="3" Margin="4,2,4,2" Padding="0"
                        Background="{DynamicResource BackgroundLevel2Brush}"
                        BorderBrush="{DynamicResource BorderSubtleBrush}"
                        BorderThickness="1" CornerRadius="6">
                    <StackPanel>
                        <Border Background="{DynamicResource PanelHeaderGradient}" CornerRadius="6,6,0,0" Padding="0">
                            <Border BorderBrush="{DynamicResource AccentOrangeBrush}" BorderThickness="3,0,0,0"
                                    CornerRadius="6,0,0,0" Padding="10,8,10,8">
                                <TextBlock Text="TIMECODE" Style="{DynamicResource PanelHeaderStyle}" Margin="0"/>
                            </Border>
                        </Border>
                        <StackPanel Margin="10,8,10,10">
                            <controls:TimecodeDisplay Timecode="{Binding Timecode.CurrentTimecode}"
                                                      HorizontalAlignment="Center"
                                                      FontSize="36"/>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,8,0,0">
                                <TextBlock Text="{Binding Timecode.Source}"
                                           Foreground="{DynamicResource TextSecondaryBrush}"/>
                                <TextBlock Text=" | " Foreground="{DynamicResource TextSecondaryBrush}"/>
                                <TextBlock Text="{Binding Timecode.SelectedTimezone.DisplayName}"
                                           Foreground="{DynamicResource TextSecondaryBrush}"/>
                            </StackPanel>
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- Audio Meters -->
                <Border Grid.Row="4" Margin="4,2,4,2" Padding="0"
                        Background="{DynamicResource BackgroundLevel2Brush}"
                        BorderBrush="{DynamicResource BorderSubtleBrush}"
                        BorderThickness="1" CornerRadius="6">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <Border Background="{DynamicResource PanelHeaderGradient}" CornerRadius="6,6,0,0" Padding="0" Grid.Row="0">
                            <Border BorderBrush="{DynamicResource AccentRedBrush}" BorderThickness="3,0,0,0"
                                    CornerRadius="6,0,0,0" Padding="10,8,10,8">
                                <TextBlock Text="AUDIO LEVELS" Style="{DynamicResource PanelHeaderStyle}" Margin="0"/>
                            </Border>
                        </Border>
                        <controls:AudioMetersPanel Grid.Row="1"
                                                   DataContext="{Binding AudioMeters}"
                                                   Margin="10,8,10,10"/>
                    </Grid>
                </Border>

                <!-- Drive Status -->
                <Border Grid.Row="5" Margin="4,2,4,4" Padding="0"
                        Background="{DynamicResource BackgroundLevel2Brush}"
                        BorderBrush="{DynamicResource BorderSubtleBrush}"
                        BorderThickness="1" CornerRadius="6">
                    <StackPanel>
                        <Border Background="{DynamicResource PanelHeaderGradient}" CornerRadius="6,6,0,0" Padding="0">
                            <Border BorderBrush="#FF9E9E9E" BorderThickness="3,0,0,0"
                                    CornerRadius="6,0,0,0" Padding="10,8,10,8">
                                <TextBlock Text="DRIVE STATUS" Style="{DynamicResource PanelHeaderStyle}" Margin="0"/>
                            </Border>
                        </Border>
                        <Grid Margin="10,8,10,10">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel>
                                <TextBlock Text="{Binding DriveStatus.DriveName}"
                                           Foreground="{DynamicResource TextPrimaryBrush}"/>
                                <TextBlock Text="{Binding DriveStatus.FreeSpaceDisplay}"
                                           Foreground="{DynamicResource TextSecondaryBrush}"/>
                                <TextBlock Text="{Binding DriveStatus.RecordingTimeRemaining}"
                                           Foreground="{DynamicResource TextSecondaryBrush}" FontSize="11"/>
                            </StackPanel>
                            <controls:DriveSpaceIndicator Grid.Column="1"
                                                          UsedPercent="{Binding DriveStatus.UsedPercent}"
                                                          Width="48" Height="48"/>
                        </Grid>
                    </StackPanel>
                </Border>
            </Grid>
            </ScrollViewer>
        </Grid>

        <!-- Status Bar -->
        <Border Grid.Row="3" Background="{DynamicResource StatusBarGradient}"
                BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="0,1,0,0"
                Padding="8,5">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0" Text="{Binding InputStatusText}"
                           Foreground="{DynamicResource TextSecondaryBrush}"/>

                <StackPanel Grid.Column="1" Orientation="Horizontal" Margin="16,0" HorizontalAlignment="Center">
                    <TextBlock Text="{Binding InputConfiguration.SelectedInput.FormatDescription}"
                               Foreground="{DynamicResource AccentBlueBrush}" FontWeight="SemiBold"/>
                </StackPanel>

                <StackPanel Grid.Column="2" Orientation="Horizontal" Margin="16,0">
                    <TextBlock Text="Dropped: " Foreground="{DynamicResource TextSecondaryBrush}"/>
                    <TextBlock Text="{Binding DroppedFrames}"
                               Foreground="{Binding DroppedFramesColor}"/>
                    <Button x:Name="ViewersButton" Command="{Binding ShowViewersCommand}"
                            Margin="16,0,0,0" Padding="6,2" Cursor="Hand"
                            Background="Transparent" BorderThickness="0"
                            Visibility="{Binding IsStreaming, Converter={StaticResource BoolToVisibilityConverter}}">
                        <StackPanel Orientation="Horizontal">
                            <Ellipse Width="6" Height="6" Fill="{DynamicResource AccentRedBrush}"
                                     VerticalAlignment="Center" Margin="0,0,4,0"/>
                            <TextBlock Text="Viewers: " Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12"/>
                            <TextBlock Text="{Binding ConnectedViewers}" Foreground="{DynamicResource AccentBlueBrush}" FontSize="12"/>
                        </StackPanel>
                    </Button>
                </StackPanel>

                <TextBlock Grid.Column="3" Text="{Binding DriveStatus.FreeSpaceDisplay}"
                           Foreground="{DynamicResource TextSecondaryBrush}" Margin="16,0"/>

                <TextBlock Grid.Column="4" Text="{Binding CurrentTime, StringFormat='{}{0:HH:mm:ss}'}"
                           Foreground="{DynamicResource TextSecondaryBrush}"/>
            </Grid>
        </Border>
    </Grid>
</Window>
